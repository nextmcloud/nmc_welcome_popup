var p,_="en_GB",u="de_DE";(function(o){o.NMC_Welcome_Popup=o.NMC_Welcome_Popup||{},o.NMC_Welcome_Popup.Admin={currentConfig:"1",slideIds:"1",noSlides:"0",maxSlides:"5",_getAppConfig:function(d){return $.ajax({type:"GET",url:OC.linkToOCS("apps/provisioning_api/api/v1",2)+"config/apps/nmc_welcome_popup/"+d+"?format=json"})},init:function(d){this._getAppConfig("slideIds").done(function(l){l.ocs.data.data!==""?(o.NMC_Welcome_Popup.Admin.slideIds=l.ocs.data.data,o.NMC_Welcome_Popup.Admin.currentConfig=o.NMC_Welcome_Popup.Admin.slideIds.split(",")[0]):o.NMC_Welcome_Popup.Admin.noSlides="1",d()})},addSlide:function(d){var l=o.NMC_Welcome_Popup.Admin.slideIds.split(",");if(l.length<o.NMC_Welcome_Popup.Admin.maxSlides){var n=1;if(l.indexOf("1")>=0)for(n=2;$.inArray(""+n,l)>=0;)n++;OCP.AppConfig.setValue("nmc_welcome_popup","slideIds",o.NMC_Welcome_Popup.Admin.slideIds+","+n,{success:function(){o.NMC_Welcome_Popup.Admin.slideIds+=","+n,o.NMC_Welcome_Popup.Admin.noSlides="0",d(n)}})}},removeSlide:function(d){if(o.NMC_Welcome_Popup.Admin.noSlides==="0"){var l=o.NMC_Welcome_Popup.Admin.slideIds.split(",");if(l.length>=1){var n=l.indexOf(this.currentConfig);n>-1&&l.splice(n,1);var g=this.currentConfig;$.ajax({url:OC.generateUrl("/apps/nmc_welcome_popup/ajax/slideSettings/"+this.currentConfig),type:"DELETE"}).done(function(i){OCP.AppConfig.setValue("nmc_welcome_popup","slideIds",l.join(","),{success:function(){l.length>0?o.NMC_Welcome_Popup.Admin.slideIds=l.join(","):(o.NMC_Welcome_Popup.Admin.noSlides="1",o.NMC_Welcome_Popup.Admin.slideIds="1"),d(g)}})})}}}}})(OCA);function w(){OC.msg.startSaving("#welcome_settings_msg"),$("#welcome_settings_loading").show()}function v(){$("#welcome_img_loaded_msg").is(":hidden")==!1&&$("#welcome_img_loaded_msg").hide(),$("#welcome_img_loading").show()}$(function(){var o=$(".slide-list .add-slide"),d=".slide-list li[data-id=";$("#slide-image").val()?$("#remove-img").show():$("#remove-img").hide(),p||(p=$("#slide-image").data("imgurl"),$("#slide-image").data("imgurl","")),$("#remove-img").click(function(i){var e=$("#slide-image").val(),a=$(".slide-list .active").data("id");v(),$.ajax({type:"DELETE",url:OC.generateUrl("/apps/nmc_welcome_popup/image/"+e),data:{slideId:a}}).done(function(s){OC.msg.finishedSaving("#welcome_img_loaded_msg",s),$("#welcome_img_loading").hide(),$("#slide-image").val(""),$("#image-uploaded").text(""),$("#remove-img").hide()}).fail(function(s){OC.msg.finishedError("#welcome_img_loaded_msg",s.responseJSON.status),$("#welcome_img_loading").hide()})}),$(".fileupload").fileupload({pasteZone:null,dropZone:null,done:function(i,e){var a=$(i.target).closest("form");a.data("image-key"),a.find("label.button").addClass("icon-upload").removeClass("icon-loading-small"),$("#welcome_img_loading").hide(),$("#image-uploaded").text(e.result.data.name),$("#slide-image").val(e.result.data.image),p=e.result.data.url},submit:function(i,e){var a=$(i.target).closest("form");a.data("image-key"),v(),a.find("label.button").removeClass("icon-upload").addClass("icon-loading-small")},fail:function(i,e){var a=$(i.target).closest("form");OC.msg.finishedError("#welcome_img_loaded_msg",e._response.jqXHR.responseJSON.data.message),a.find("label.button").addClass("icon-upload").removeClass("icon-loading-small"),$("#welcome_img_loading").hide()}}),$("#add_new_popup").click(function(){var i=$(".slide-list .active").data("id");w(),$.post(OC.generateUrl("/apps/nmc_welcome_popup/ajax/slideSettings/"+i),l()).done(function(e){OC.msg.finishedSaving("#welcome_settings_msg",e),$("#welcome_settings_loading").hide(),$("#slide-image").val()&&$("#remove-img").show()}).fail(function(e){OC.msg.finishedError("#welcome_settings_msg",e.responseJSON.data.message),$("#welcome_settings_loading").hide()})}),$(".show-preview").click(function(i){var e=$(this).data("lang");i.stopPropagation(),i.preventDefault();var a=l().slide,s=a.image_uploaded;if(!s)p="";else if(!p){var t=Math.round(new Date().getTime()/1e3);p=OC.generateUrl("/apps/nmc_welcome_popup/image/"+s)+"?v="+t}var c=a[e];return c.image_url=p,console.log(c),OCP.Loader.loadScript("nmc_welcome_popup","nmc_welcome_popup-main.mjs").then(function(){window.OCA.NMC_Welcome_Popup.NcModal.previewSlide([c])}),!1});function l(){var i=$("#"+_+"-slide-title").val(),e=$("#"+_+"-primary-button-label").val(),a=$("#"+_+"-primary-button-url").val(),s=$("#"+_+"-secondary-button-desc").val(),t=$("#"+_+"-text").val(),c=$("#"+u+"-slide-title").val(),r=$("#"+u+"-primary-button-label").val(),m=$("#"+u+"-primary-button-url").val(),f=$("#"+u+"-secondary-button-desc").val(),C=$("#"+u+"-text").val(),h=$("#slide-image").val();return{slide:{en_GB:{title:i,primary_button_label:e,primary_button_url:a,secondary_button_desc:s,content:t},de_DE:{title:c,primary_button_label:r,primary_button_url:m,secondary_button_desc:f,content:C},image_uploaded:h}}}OCA.NMC_Welcome_Popup.Admin.init(function(){$(d+'"'+OCA.NMC_Welcome_Popup.Admin.currentConfig+'"]').addClass("active")});var n=function(i){$(".slide-list li").removeClass("active"),$(d+'"'+i+'"]').addClass("active"),$("#welcome_img_loaded_msg").is(":hidden")==!1&&$("#welcome_img_loaded_msg").hide(),$("#welcome_settings_msg").is(":hidden")==!1&&$("#welcome_settings_msg").hide(),OCA.NMC_Welcome_Popup.Admin.currentConfig=""+i,$.get(OC.generateUrl("/apps/nmc_welcome_popup/ajax/slideSettings/"+i)).done(function(e){if(Object.entries(e).length>0)Object.keys(e).forEach(function(t){if(t==_||t==u){var c=e[t];Object.keys(c).forEach(function(r){var m=$('#welcome_popup *[data-key="'+t+"_"+r+'"]');if(m.is("input")&&(m.prop("type")==="text"||m.prop("type")==="number"||m.prop("type")==="url"))m.val(c[r]);else if(m.is("textarea"))m.val(c[r]);else if(m.prop("type")==="checkbox"){var f=c[r]==="1"?"1":"0";m.val(f)}else console.log("unable to find element for "+r)})}else t=="image_uploaded"?($("#slide-image").val(e[t]),$("#slide-image").val()?$("#remove-img").show():$("#remove-img").hide()):t=="image_url"&&(p=e[t])});else{var a=$("#welcome_popup *[data-key]");a.val(""),$("#slide-image").val(""),$("#remove-img").hide()}var s=$("#image-name");s.val(s.data("key")+"_"+i),$("#image-uploaded").text(""),$('input:checkbox[value="1"]').attr("checked",!0),$('input:checkbox[value="0"]').attr("checked",!1)})};o.on("click",function(){OCA.NMC_Welcome_Popup.Admin.addSlide(function(i){var e=OCA.NMC_Welcome_Popup.Admin.slideIds.split(",");$('<li data-id="'+i+'"><a>Slide '+e.length+"</a></li>").insertBefore(o[0]),n(i),e.length>=OCA.NMC_Welcome_Popup.Admin.maxSlides&&o.hide()})}),$(".slide-list").on("click","li:not(.add-slide)",function(){var i=""+$(this).data("id");n(i)}),$("#remove_slide").on("click",function(){OCA.NMC_Welcome_Popup.Admin.removeSlide(function(i){OC.msg.finishedSuccess("#remove_slide_msg","Slide removed");var e=OCA.NMC_Welcome_Popup.Admin.slideIds.split(",");OCA.NMC_Welcome_Popup.Admin.noSlides==="0"?($(d+'"'+i+'"]').remove(),g(e),n(e[0])):($(d+'"'+i+'"]').attr("data-id",e[0]),n(e[0])),o.is(":hidden")&&o.show()})});function g(i){for(id=0;id<i.length;id++)$(d+'"'+i[id]+'"] a').text(function(e,a){return"Slide "+(id+1)})}});
