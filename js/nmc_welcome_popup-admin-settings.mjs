var _,g="en_GB",f="de_DE";(function(a){a.NMC_Welcome_Popup=a.NMC_Welcome_Popup||{},a.NMC_Welcome_Popup.Admin={currentConfig:"1",slideIds:"1",noSlides:"0",maxSlides:"5",_getAppConfig:function(s){return $.ajax({type:"GET",url:OC.linkToOCS("apps/provisioning_api/api/v1",2)+"config/apps/nmc_welcome_popup/"+s+"?format=json"})},init:function(s){this._getAppConfig("slideIds").done(function(n){n.ocs.data.data!==""?(a.NMC_Welcome_Popup.Admin.slideIds=n.ocs.data.data,a.NMC_Welcome_Popup.Admin.currentConfig=a.NMC_Welcome_Popup.Admin.slideIds.split(",")[0]):a.NMC_Welcome_Popup.Admin.noSlides="1",s()})},addSlide:function(s){var n=a.NMC_Welcome_Popup.Admin.slideIds.split(",");if(n.length<a.NMC_Welcome_Popup.Admin.maxSlides){var d=1;if(n.indexOf("1")>=0)for(d=2;$.inArray(""+d,n)>=0;)d++;OCP.AppConfig.setValue("nmc_welcome_popup","slideIds",a.NMC_Welcome_Popup.Admin.slideIds+","+d,{success:function(){a.NMC_Welcome_Popup.Admin.slideIds+=","+d,a.NMC_Welcome_Popup.Admin.noSlides="0",s(d)}})}},removeSlide:function(s){if(a.NMC_Welcome_Popup.Admin.noSlides==="0"){var n=a.NMC_Welcome_Popup.Admin.slideIds.split(",");if(n.length>=1){var d=n.indexOf(this.currentConfig);d>-1&&n.splice(d,1);var v=this.currentConfig;$.ajax({url:OC.generateUrl("/apps/nmc_welcome_popup/ajax/slideSettings/"+this.currentConfig),type:"DELETE"}).done(function(o){OCP.AppConfig.setValue("nmc_welcome_popup","slideIds",n.join(","),{success:function(){n.length>0?a.NMC_Welcome_Popup.Admin.slideIds=n.join(","):(a.NMC_Welcome_Popup.Admin.noSlides="1",a.NMC_Welcome_Popup.Admin.slideIds="1"),s(v)}})})}}}}})(OCA);function O(){OC.msg.startSaving("#welcome_settings_msg"),$("#welcome_settings_loading").show()}function C(){$("#welcome_img_loaded_msg").is(":hidden")===!1&&$("#welcome_img_loaded_msg").hide(),$("#welcome_img_loading").show()}$(function(){var a=$(".slide-list .add-slide"),s=".slide-list li[data-id=";$("#slide-image").val()?$("#remove-img").show():$("#remove-img").hide(),_||(_=$("#slide-image").data("imgurl"),$("#slide-image").data("imgurl","")),$("#remove-img").click(function(){var o=$("#slide-image").val(),e=$(".slide-list .active").data("id");C(),$.ajax({type:"DELETE",url:OC.generateUrl("/apps/nmc_welcome_popup/image/"+o),data:{slideId:e}}).done(function(m){OC.msg.finishedSaving("#welcome_img_loaded_msg",m),$("#welcome_img_loading").hide(),$("#slide-image").val(""),$("#image-uploaded").text(""),$("#remove-img").hide()}).fail(function(m){OC.msg.finishedError("#welcome_img_loaded_msg",m.responseJSON.status),$("#welcome_img_loading").hide()})}),$(".fileupload").on("change",function(o){var e=this,m=e.files&&e.files[0];if(m){var p=$(e).closest("form"),l=p.attr("action");if(!l){console.error("No form action defined for image upload.");return}C(),p.find("label.button").removeClass("icon-upload").addClass("icon-loading-small");var c=new FormData(p[0]),r=$(e).attr("name")||"file";c.set(r,m),$.ajax({url:l,method:"POST",data:c,processData:!1,contentType:!1,success:function(i){i&&i.data&&($("#image-uploaded").text(i.data.name||""),$("#slide-image").val(i.data.image||""),_=i.data.url||_),p.find("label.button").addClass("icon-upload").removeClass("icon-loading-small"),$("#welcome_img_loading").hide()},error:function(i){let u=t("nmc_welcome_popup","Image upload failed");i.status===422?i.responseJSON&&i.responseJSON.data&&i.responseJSON.data.message?u=i.responseJSON.data.message:u=t("nmc_welcome_popup","The uploaded file is too large or invalid."):i.responseJSON&&i.responseJSON.status==="failure"&&i.responseJSON.data&&i.responseJSON.data.message&&(u=i.responseJSON.data.message),OC.msg.finishedError("#welcome_img_loaded_msg",u),p.find("label.button").addClass("icon-upload").removeClass("icon-loading-small"),$("#welcome_img_loading").hide()}})}}),$("#add_new_popup").click(function(){var o=$(".slide-list .active").data("id");O(),$.post(OC.generateUrl("/apps/nmc_welcome_popup/ajax/slideSettings/"+o),n()).done(function(e){OC.msg.finishedSaving("#welcome_settings_msg",e),$("#welcome_settings_loading").hide(),$("#slide-image").val()&&$("#remove-img").show()}).fail(function(e){OC.msg.finishedError("#welcome_settings_msg",e.responseJSON.data.message),$("#welcome_settings_loading").hide()})}),$(".show-preview").click(function(o){var e=$(this).data("lang");o.stopPropagation(),o.preventDefault();var m=n().slide,p=m.image_uploaded;if(!p)_="";else if(!_){var l=Math.round(new Date().getTime()/1e3);_=OC.generateUrl("/apps/nmc_welcome_popup/image/"+p)+"?v="+l}var c=m[e];return c.image_url=_,console.log(c),OCP.Loader.loadScript("nmc_welcome_popup","nmc_welcome_popup-main.mjs").then(function(){window.OCA.NMC_Welcome_Popup.NcModal.previewSlide([c])}),!1});function n(){var o=$("#"+g+"-slide-title").val(),e=$("#"+g+"-primary-button-label").val(),m=$("#"+g+"-primary-button-url").val(),p=$("#"+g+"-secondary-button-desc").val(),l=$("#"+g+"-text").val(),c=$("#"+f+"-slide-title").val(),r=$("#"+f+"-primary-button-label").val(),i=$("#"+f+"-primary-button-url").val(),u=$("#"+f+"-secondary-button-desc").val(),h=$("#"+f+"-text").val(),w=$("#slide-image").val();return{slide:{en_GB:{title:o,primary_button_label:e,primary_button_url:m,secondary_button_desc:p,content:l},de_DE:{title:c,primary_button_label:r,primary_button_url:i,secondary_button_desc:u,content:h},image_uploaded:w}}}OCA.NMC_Welcome_Popup.Admin.init(function(){$(s+'"'+OCA.NMC_Welcome_Popup.Admin.currentConfig+'"]').addClass("active")});var d=function(o){$(".slide-list li").removeClass("active"),$(s+'"'+o+'"]').addClass("active"),$("#welcome_img_loaded_msg").is(":hidden")===!1&&$("#welcome_img_loaded_msg").hide(),$("#welcome_settings_msg").is(":hidden")===!1&&$("#welcome_settings_msg").hide(),OCA.NMC_Welcome_Popup.Admin.currentConfig=""+o,$.get(OC.generateUrl("/apps/nmc_welcome_popup/ajax/slideSettings/"+o)).done(function(e){if(Object.entries(e).length>0)Object.keys(e).forEach(function(l){if(l===g||l===f){var c=e[l];Object.keys(c).forEach(function(r){var i=$('#welcome_popup *[data-key="'+l+"_"+r+'"]');if(i.is("input")&&(i.prop("type")==="text"||i.prop("type")==="number"||i.prop("type")==="url"))i.val(c[r]);else if(i.is("textarea"))i.val(c[r]);else if(i.prop("type")==="checkbox"){var u=c[r]==="1"?"1":"0";i.val(u)}else console.log("unable to find element for "+r)})}else l==="image_uploaded"?($("#slide-image").val(e[l]),$("#slide-image").val()?$("#remove-img").show():$("#remove-img").hide()):l==="image_url"&&(_=e[l])});else{var m=$("#welcome_popup *[data-key]");m.val(""),$("#slide-image").val(""),$("#remove-img").hide()}var p=$("#image-name");p.val(p.data("key")+"_"+o),$("#image-uploaded").text(""),$('input:checkbox[value="1"]').attr("checked",!0),$('input:checkbox[value="0"]').attr("checked",!1)})};a.on("click",function(){OCA.NMC_Welcome_Popup.Admin.addSlide(function(o){var e=OCA.NMC_Welcome_Popup.Admin.slideIds.split(",");$('<li data-id="'+o+'"><a>Slide '+e.length+"</a></li>").insertBefore(a[0]),d(o),e.length>=OCA.NMC_Welcome_Popup.Admin.maxSlides&&a.hide()})}),$(".slide-list").on("click","li:not(.add-slide)",function(){var o=""+$(this).data("id");d(o)}),$("#remove_slide").on("click",function(){OCA.NMC_Welcome_Popup.Admin.removeSlide(function(o){OC.msg.finishedSuccess("#remove_slide_msg","Slide removed");var e=OCA.NMC_Welcome_Popup.Admin.slideIds.split(",");OCA.NMC_Welcome_Popup.Admin.noSlides==="0"?($(s+'"'+o+'"]').remove(),v(e),d(e[0])):($(s+'"'+o+'"]').attr("data-id",e[0]),d(e[0])),a.is(":hidden")&&a.show()})});function v(o){for(var e=0;e<o.length;e++)$(s+'"'+o[e]+'"] a').text(function(){return"Slide "+(e+1)})}});
//# sourceMappingURL=nmc_welcome_popup-admin-settings.mjs.map
