{"version":3,"file":"nmc_welcome_popup-settings-admin.js?v=a0457fb4b689ac731a64","mappings":";;;;;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","sources":["webpack:///nmc_welcome_popup/src/js/settings-admin.js"],"sourcesContent":["/**\r\n * @author Björn Schießle <bjoern@schiessle.org>\r\n *\r\n * @copyright Copyright (c) 2016, Bjoern Schiessle\r\n * @license AGPL-3.0\r\n *\r\n * This code is free software: you can redistribute it and/or modify\r\n * it under the terms of the GNU Affero General Public License as\r\n * published by the Free Software Foundation, either version 3 of the\r\n * License, or (at your opinion) any later version.\r\n *\r\n * This program is distributed in the hope that it will be useful,\r\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\r\n * GNU Affero General Public License for more details.\r\n *\r\n * You should have received a copy of the GNU Affero General Public License\r\n * along with this program.  If not, see <http://www.gnu.org/licenses/>\r\n *\r\n */\n\nvar imgUrl;\nvar en = 'en_GB';\nvar de = 'de_DE';\n(function (OCA) {\n  OCA.NMC_Welcome_Popup = OCA.NMC_Welcome_Popup || {};\n\n  /**\r\n   * @namespace OCA.NMC_Welcome_Popup.Admin\r\n   */\n  OCA.NMC_Welcome_Popup.Admin = {\n    currentConfig: '1',\n    slideIds: '1',\n    noSlides: '0',\n    maxSlides: '5',\n    _getAppConfig: function (key) {\n      return $.ajax({\n        type: 'GET',\n        url: OC.linkToOCS('apps/provisioning_api/api/v1', 2) + 'config/apps' + '/nmc_welcome_popup/' + key + '?format=json'\n      });\n    },\n    init: function (callback) {\n      this._getAppConfig('slideIds').done(function (data) {\n        if (data.ocs.data.data !== '') {\n          OCA.NMC_Welcome_Popup.Admin.slideIds = data.ocs.data.data;\n          OCA.NMC_Welcome_Popup.Admin.currentConfig = OCA.NMC_Welcome_Popup.Admin.slideIds.split(',')[0];\n        } else {\n          OCA.NMC_Welcome_Popup.Admin.noSlides = '1';\n        }\n        callback();\n      });\n    },\n    /**\r\n     * Add a new slide\r\n     * @returns {number} id of the slide\r\n     */\n    addSlide: function (callback) {\n      var slideIds = OCA.NMC_Welcome_Popup.Admin.slideIds.split(',');\n      if (slideIds.length < OCA.NMC_Welcome_Popup.Admin.maxSlides) {\n        var nextId = 1;\n        if (slideIds.indexOf('1') >= 0) {\n          nextId = 2;\n          while ($.inArray('' + nextId, slideIds) >= 0) {\n            nextId++;\n          }\n        }\n        OCP.AppConfig.setValue('nmc_welcome_popup', 'slideIds', OCA.NMC_Welcome_Popup.Admin.slideIds + ',' + nextId, {\n          success: function () {\n            OCA.NMC_Welcome_Popup.Admin.slideIds += ',' + nextId;\n            OCA.NMC_Welcome_Popup.Admin.noSlides = '0';\n            callback(nextId);\n          }\n        });\n      }\n    },\n    removeSlide: function (callback) {\n      if (OCA.NMC_Welcome_Popup.Admin.noSlides === '0') {\n        var slideIds = OCA.NMC_Welcome_Popup.Admin.slideIds.split(',');\n        if (slideIds.length >= 1) {\n          var index = slideIds.indexOf(this.currentConfig);\n          if (index > -1) {\n            slideIds.splice(index, 1);\n          }\n          var config = this.currentConfig;\n          $.ajax({\n            url: OC.generateUrl('/apps/nmc_welcome_popup/ajax/slideSettings/' + this.currentConfig),\n            type: 'DELETE'\n          }).done(function (data) {\n            OCP.AppConfig.setValue('nmc_welcome_popup', 'slideIds', slideIds.join(','), {\n              success: function () {\n                if (slideIds.length > 0) {\n                  OCA.NMC_Welcome_Popup.Admin.slideIds = slideIds.join(',');\n                } else {\n                  OCA.NMC_Welcome_Popup.Admin.noSlides = '1';\n                  OCA.NMC_Welcome_Popup.Admin.slideIds = '1';\n                }\n                callback(config);\n              }\n            });\n          });\n        }\n      }\n    }\n  };\n})(OCA);\nfunction startLoading() {\n  OC.msg.startSaving('#welcome_settings_msg');\n  $('#welcome_settings_loading').show();\n}\nfunction startLoadingImg() {\n  // OC.msg.startSaving('#welcome_img_loaded_msg');\n  if ($('#welcome_img_loaded_msg').is(\":hidden\") == false) {\n    $('#welcome_img_loaded_msg').hide();\n  }\n  $('#welcome_img_loading').show();\n}\n$(function () {\n  // $('#welcome_popup [data-toggle=\"tooltip\"]').tooltip();\n\n  var addSlideBtn = $('.slide-list .add-slide');\n  var slideDataId = '.slide-list li[data-id=';\n  if ($('#slide-image').val()) {\n    $('#remove-img').show();\n  } else {\n    $('#remove-img').hide();\n  }\n  if (!imgUrl) {\n    imgUrl = $('#slide-image').data('imgurl');\n    $('#slide-image').data('imgurl', '');\n  }\n  $('#remove-img').click(function (e) {\n    var image_name = $('#slide-image').val();\n    var slideId = $('.slide-list .active').data('id');\n    startLoadingImg();\n    $.ajax({\n      type: \"DELETE\",\n      url: OC.generateUrl('/apps/nmc_welcome_popup/image/' + image_name),\n      data: {\n        'slideId': slideId\n      }\n    }).done(function (response) {\n      OC.msg.finishedSaving('#welcome_img_loaded_msg', response);\n      $('#welcome_img_loading').hide();\n      $(\"#slide-image\").val(\"\");\n      $(\"#image-uploaded\").text(\"\");\n      $('#remove-img').hide();\n    }).fail(function (response) {\n      OC.msg.finishedError('#welcome_img_loaded_msg', response.responseJSON.status);\n      $('#welcome_img_loading').hide();\n    });\n  });\n  $('.fileupload').fileupload({\n    pasteZone: null,\n    dropZone: null,\n    done: function (e, response) {\n      var $form = $(e.target).closest('form');\n      var key = $form.data('image-key');\n\n      // OC.msg.finishedSaving('#welcome_img_loaded_msg', response.result);\n      $form.find('label.button').addClass('icon-upload').removeClass('icon-loading-small');\n      $('#welcome_img_loading').hide();\n      $(\"#image-uploaded\").text(response.result.data.name);\n      $(\"#slide-image\").val(response.result.data.image);\n      imgUrl = response.result.data.url;\n      // $('#remove-img').show();\n    },\n    submit: function (e, response) {\n      var $form = $(e.target).closest('form');\n      var key = $form.data('image-key');\n      startLoadingImg();\n      $form.find('label.button').removeClass('icon-upload').addClass('icon-loading-small');\n    },\n    fail: function (e, response) {\n      var $form = $(e.target).closest('form');\n      OC.msg.finishedError('#welcome_img_loaded_msg', response._response.jqXHR.responseJSON.data.message);\n      $form.find('label.button').addClass('icon-upload').removeClass('icon-loading-small');\n      $('#welcome_img_loading').hide();\n    }\n  });\n  $('#add_new_popup').click(function () {\n    var slideId = $('.slide-list .active').data('id');\n    startLoading();\n    $.post(OC.generateUrl('/apps/nmc_welcome_popup/ajax/slideSettings/' + slideId), getParams()).done(function (response) {\n      OC.msg.finishedSaving('#welcome_settings_msg', response);\n      $('#welcome_settings_loading').hide();\n      if ($('#slide-image').val()) {\n        $('#remove-img').show();\n      }\n    }).fail(function (response) {\n      OC.msg.finishedError('#welcome_settings_msg', response.responseJSON.data.message);\n      $('#welcome_settings_loading').hide();\n    });\n  });\n  $('.show-preview').click(function (event) {\n    var lang = $(this).data('lang');\n    event.stopPropagation();\n    event.preventDefault();\n    var slide_params = getParams().slide;\n    var image_name = slide_params.image_uploaded;\n    if (!image_name) {\n      imgUrl = \"\";\n    } else if (!imgUrl) {\n      var cachebusterImg = Math.round(new Date().getTime() / 1000);\n      imgUrl = OC.generateUrl('/apps/nmc_welcome_popup/image/' + image_name) + '?v=' + cachebusterImg;\n    }\n    var langSlide = slide_params[lang];\n    langSlide.image_url = imgUrl;\n    OCP.Loader.loadScript('nmc_welcome_popup', 'nmc_welcome_popup-main.js').then(function () {\n      window.OCA.NMC_Welcome_Popup.Modal.previewSlide([langSlide]);\n    });\n    return false;\n  });\n  function getParams() {\n    var en_title = $('#' + en + '-slide-title').val();\n    var en_primaryBtnLbl = $('#' + en + '-primary-button-label').val();\n    var en_primaryBtnUrl = $('#' + en + '-primary-button-url').val();\n    var en_secondaryBtnDesc = $('#' + en + '-secondary-button-desc').val();\n    var en_text = $('#' + en + '-text').val();\n    var de_title = $('#' + de + '-slide-title').val();\n    var de_primaryBtnLbl = $('#' + de + '-primary-button-label').val();\n    var de_primaryBtnUrl = $('#' + de + '-primary-button-url').val();\n    var de_secondaryBtnDesc = $('#' + de + '-secondary-button-desc').val();\n    var de_text = $('#' + de + '-text').val();\n    var image_name = $('#slide-image').val();\n    return {\n      'slide': {\n        'en_GB': {\n          'title': en_title,\n          'primary_button_label': en_primaryBtnLbl,\n          'primary_button_url': en_primaryBtnUrl,\n          'secondary_button_desc': en_secondaryBtnDesc,\n          'content': en_text\n        },\n        'de_DE': {\n          'title': de_title,\n          'primary_button_label': de_primaryBtnLbl,\n          'primary_button_url': de_primaryBtnUrl,\n          'secondary_button_desc': de_secondaryBtnDesc,\n          'content': de_text\n        },\n        'image_uploaded': image_name\n      }\n    };\n  }\n  OCA.NMC_Welcome_Popup.Admin.init(function () {\n    $(slideDataId + '\"' + OCA.NMC_Welcome_Popup.Admin.currentConfig + '\"]').addClass('active');\n  });\n  var switchSlide = function (slideId) {\n    $('.slide-list li').removeClass('active');\n    $(slideDataId + '\"' + slideId + '\"]').addClass('active');\n    if ($('#welcome_img_loaded_msg').is(\":hidden\") == false) {\n      $('#welcome_img_loaded_msg').hide();\n    }\n    if ($('#welcome_settings_msg').is(\":hidden\") == false) {\n      $('#welcome_settings_msg').hide();\n    }\n    OCA.NMC_Welcome_Popup.Admin.currentConfig = '' + slideId;\n    $.get(OC.generateUrl('/apps/nmc_welcome_popup/ajax/slideSettings/' + slideId)).done(function (data) {\n      if (Object.entries(data).length > 0) {\n        Object.keys(data).forEach(function (form_section) {\n          if (form_section == en || form_section == de) {\n            var entries = data[form_section];\n            Object.keys(entries).forEach(function (configKey) {\n              var element = $('#welcome_popup *[data-key=\"' + form_section + '_' + configKey + '\"]');\n              if (element.is('input') && (element.prop('type') === 'text' || element.prop('type') === 'number' || element.prop('type') === 'url')) {\n                element.val(entries[configKey]);\n              } else if (element.is('textarea')) {\n                element.val(entries[configKey]);\n              } else if (element.prop('type') === 'checkbox') {\n                var value = entries[configKey] === '1' ? '1' : '0';\n                element.val(value);\n              } else {\n                console.log('unable to find element for ' + configKey);\n              }\n            });\n          } else if (form_section == 'image_uploaded') {\n            $(\"#slide-image\").val(data[form_section]);\n            if ($('#slide-image').val()) {\n              $('#remove-img').show();\n            } else {\n              $('#remove-img').hide();\n            }\n          } else if (form_section == 'image_url') {\n            imgUrl = data[form_section];\n          }\n        });\n      } else {\n        var element = $('#welcome_popup *[data-key]');\n        element.val(\"\");\n        $(\"#slide-image\").val(\"\");\n        $('#remove-img').hide();\n      }\n      var imgName = $(\"#image-name\");\n      imgName.val(imgName.data('key') + '_' + slideId);\n      $(\"#image-uploaded\").text(\"\");\n      $('input:checkbox[value=\"1\"]').attr('checked', true);\n      $('input:checkbox[value=\"0\"]').attr('checked', false);\n    });\n  };\n  addSlideBtn.on('click', function () {\n    OCA.NMC_Welcome_Popup.Admin.addSlide(function (nextId) {\n      var slideIds = OCA.NMC_Welcome_Popup.Admin.slideIds.split(',');\n      $('<li data-id=\"' + nextId + '\"><a>Slide ' + slideIds.length + '</a></li>').insertBefore(addSlideBtn[0]);\n      switchSlide(nextId);\n      if (slideIds.length >= OCA.NMC_Welcome_Popup.Admin.maxSlides) {\n        addSlideBtn.hide();\n      }\n    });\n  });\n  $('.slide-list').on('click', 'li:not(.add-slide)', function () {\n    var slideId = '' + $(this).data('id');\n    switchSlide(slideId);\n  });\n  $('#remove_slide').on('click', function () {\n    OCA.NMC_Welcome_Popup.Admin.removeSlide(function (currentConfig) {\n      OC.msg.finishedSuccess('#remove_slide_msg', \"Slide removed\");\n      var slideIds = OCA.NMC_Welcome_Popup.Admin.slideIds.split(',');\n      if (OCA.NMC_Welcome_Popup.Admin.noSlides === '0') {\n        $(slideDataId + '\"' + currentConfig + '\"]').remove();\n        renameSlides(slideIds);\n        switchSlide(slideIds[0]);\n      } else {\n        $(slideDataId + '\"' + currentConfig + '\"]').attr('data-id', slideIds[0]);\n        switchSlide(slideIds[0]);\n      }\n      if (addSlideBtn.is(\":hidden\")) {\n        addSlideBtn.show();\n      }\n    });\n  });\n  function renameSlides(slideIds) {\n    for (id = 0; id < slideIds.length; id++) {\n      $(slideDataId + '\"' + slideIds[id] + '\"] a').text(function (_, text) {\n        return \"Slide \" + (id + 1);\n      });\n    }\n  }\n});"],"names":[],"sourceRoot":""}